import{d as Y,Z as te,m as ye,a as p,i as oe,j as se,y as ne,o as d,b as m,e as n,t as R,f as D,F as z,l as ae,s as ee,u as L,v as U,G as T,C as V,D as N,H as we,n as F,p as ke,g as he,_ as Q,$ as fe,x as j,z as G,A as Z,E as X,r as de,h as Te}from"./index-C8_KvqLc.js";import{D as De}from"./db-6kmVuVtA.js";import{_ as Ge,a as Le,v as ge,A as q,b as W,c as Ve,d as Me,D as Ee,e as pe}from"./aiConfig-Bu_ffJ7U.js";import{m as $}from"./MjMessage-B6PxiNxc.js";import{m as Ce}from"./mjmodal-Dt-Lc6FC.js";import{M as _e}from"./MjTextarea-yOKFGuNi.js";import{_ as Be}from"./RightIcon.vue_vue_type_script_setup_true_lang-BCkZ8AjK.js";import{_ as ve}from"./MjMd.vue_vue_type_style_index_0_lang-Ca3UJ58x.js";import{_ as Ie}from"./DownIcon.vue_vue_type_script_setup_true_lang-CXD0Fd_i.js";import{M as Oe}from"./MjSelect-CB5zIzi7.js";import"./MjModal-D8GbfQV7.js";import"./CloseIcon.vue_vue_type_script_setup_true_lang-BO1-knco.js";import"./MjButton-BmN55pLQ.js";import"./LoadingIcon.vue_vue_type_script_setup_true_lang-Cjl4ccjb.js";import"./index-C1s-hTSf.js";const $e=b=>(ke("data-v-c2e4b3d0"),b=b(),he(),b),Ae={class:"ds-group"},Ne={class:"ds-group-header"},Pe={class:"ds-group-list"},Ue=["onClick"],je={class:"deepseek-mask"},ze={class:"ds-group-modal"},He=$e(()=>n("div",{class:"ds-group-modal-header"},"分组",-1)),Je={class:"ds-group-modal-card"},We={class:"ds-group-modal-row"},Xe=$e(()=>n("label",{class:"ds-group-modal-label",for:"ds-groupname"},"名称",-1)),Ye={class:"ds-group-modal-btns"},Fe=Y({__name:"DeepSeekGroup",setup(b){const k=te(),E=ye(),y=p([]),{dbtool:r}=oe("ds"),c=p(!1),v=p(""),l=p(0),a=p(null),h=p({x:0,y:0}),f=()=>{l.value?r.updateGroup(l.value,v.value).then(t=>{t!=null&&t.success?$.success((t==null?void 0:t.msg)||"编辑成功"):$.error((t==null?void 0:t.msg)||"编辑失败")}):r.addGroup(v.value).then(t=>{t!=null&&t.success?$.success((t==null?void 0:t.msg)||"添加成功"):$.error((t==null?void 0:t.msg)||"添加失败")}),c.value=!1,r.getGroupList().then(t=>{y.value=t})},K=()=>{c.value=!0,l.value=0,v.value=""},O=()=>{a.value&&(c.value=!0,l.value=a.value.key,v.value=a.value.name,a.value=null)},g=()=>{a.value&&(l.value=a.value.key,a.value=null,Ce.confirm({title:"删除",content:"是否确定删除"}).then(()=>{r.deleteGroup(l.value).then(t=>{t!=null&&t.success?($.success((t==null?void 0:t.msg)||"删除成功"),r.getGroupList().then(i=>{y.value=i})):$.error((t==null?void 0:t.msg)||"删除失败")})}).catch(t=>{console.log(t)}).finally(()=>{l.value=0}))},u=t=>{k.push({name:"tool-deepseek",params:{groupKey:t}})},B=(t,i)=>{a.value=t,h.value={x:i.clientX,y:i.clientY}};r.getGroupList().then(t=>{y.value=t});const I=()=>{a.value=null};return se(()=>{window.addEventListener("click",I)}),ne(()=>{window.removeEventListener("click",I)}),(t,i)=>(d(),m("div",Ae,[n("dt",Ne,[R("分组 "),D(Ge,{onClick:K})]),n("div",Pe,[(d(!0),m(z,null,ae(y.value,C=>(d(),m("dl",{class:ee(["ds-group-item",{"ds-group-item--active":C.key.toString()===L(E).params.groupKey}]),key:C.key,onClick:M=>u(C.key)},[R(U(C.name)+" ",1),D(Le,{onClick:T(M=>B(C,M),["stop"])},null,8,["onClick"])],10,Ue))),128))]),V(n("div",je,[n("div",ze,[He,n("div",Je,[n("dl",We,[Xe,V(n("input",{class:"ds-group-modal-ipt",id:"ds-groupname",placeholder:"请输入分组名称","onUpdate:modelValue":i[0]||(i[0]=C=>v.value=C),autocomplete:"off"},null,512),[[we,v.value]])])]),n("div",Ye,[n("button",{onClick:i[1]||(i[1]=C=>c.value=!1)},"取消"),n("button",{onClick:f},"保存")])])],512),[[N,c.value]]),V(n("div",{class:"ds-group-more-opactions",style:F({left:`${h.value.x}px`,top:`${h.value.y}px`})},[n("dl",{onClick:O},"编辑名称"),n("dl",{style:{color:"red"},onClick:g},"删除")],4),[[N,a.value]])]))}}),me=Q(Fe,[["__scopeId","data-v-c2e4b3d0"]]),Qe=b=>(ke("data-v-11dd6723"),b=b(),he(),b),Ze={class:"ds-group-detail"},qe={class:"ds-group-detail-info"},Re={class:"group-detail-sys"},et={class:"group-chat-list"},tt=["onClick","onContextmenu"],ot={key:0,class:"group-chat-name"},st={class:"group-chat-content"},nt={class:"deepseek-mask"},at={class:"group-detail-sys-modal"},lt=Qe(()=>n("div",{class:"group-detail-sys-modal-header"},"设置指令",-1)),it={class:"group-detail-sys-modal-btns"},ut=Y({__name:"DeepSeekGroupDetail",props:{group:{}},emits:["groupUpdate"],setup(b,{emit:k}){const E=k,y=te(),r=b,{group:c}=fe(r),{dbtool:v}=oe("ds"),l=p([]),a=p(!1),h=p(""),f=p(null),K=p({x:0,y:0}),O=(o,e)=>{f.value=o,K.value={x:e.clientX,y:e.clientY}},g=()=>{l.value=[],v.getChatListByGroupKey(c.value.key).then(o=>{o.success&&(l.value=o.data||[])})},u=()=>{f.value&&Ce.confirm({title:"删除",content:"是否确定删除"}).then(()=>{v.deleteChat(f.value.key).then(o=>{o!=null&&o.success?($.success((o==null?void 0:o.msg)||"删除成功"),g()):$.error((o==null?void 0:o.msg)||"删除失败")})}).catch(o=>{console.log(o)}).finally(()=>{f.value=null})},B=()=>{v.getContentListByGhatKey(f.value.key).then(o=>{o.success&&navigator.clipboard.writeText("deepseekcopy"+JSON.stringify((o.data||[]).map(e=>`${e.role}:${(e.content||"").replace(/(^[\n\s]+|[\n\s]+$)/g,"")}`))).then(()=>{$.success("复制成功")}).catch(e=>{$.error((e==null?void 0:e.message)||"复制失败")})})},I=()=>{y.push(`/tool/deepseek-copy/${f.value.key}`)},t=()=>{navigator.clipboard.readText().then(o=>{if(typeof o=="string"&&/^deepseekcopy/.test(o))try{const s=JSON.parse(o.slice(12)).map(_=>{const[S,x]=_.match(new RegExp("(^[^:]+|(?<=:)[\\w\\W]+$)","g"))||[];return{role:S,content:x}});s.length>0&&v.importContentList({contentList:s,groupKey:c.value.key}).then(()=>{g(),$.success("粘贴成功")})}catch{$.error("粘贴失败")}else $.error("粘贴失败")})};j(()=>c.value.key,()=>{g()},{immediate:!0});const i=()=>{h.value=c.value.sysPreset,a.value=!0},C=()=>{v.updateGroup(c.value.key,c.value.name,h.value).then(()=>{a.value=!1,E("groupUpdate",{...c.value,sysPreset:h.value}),h.value=""})},M=o=>{y.push({name:"tool-deepseek",params:{groupKey:c.value.key,chatKey:o}})},P=()=>{f.value=null};return se(()=>{window.addEventListener("click",P)}),ne(()=>{window.removeEventListener("click",P)}),(o,e)=>(d(),m("div",Ze,[n("h1",null,U(L(c).name),1),n("div",qe,[n("div",Re,[n("div",{class:"group-detail-sys-text",onClick:i},U(L(c).sysPreset||"添加指令"),1),D(Be)]),n("div",{onClick:t},"粘贴")]),n("div",et,[(d(!0),m(z,null,ae(l.value,s=>V((d(),m("div",{class:"group-chat-item",key:s.key,onClick:_=>M(s.key),onContextmenu:T(_=>O(s,_),["prevent"])},[s.name?(d(),m("div",ot,U(s.name),1)):G("",!0),n("div",st,U(s.lastMsg),1)],40,tt)),[[L(ge),{handler:_=>{O(s,_)}}]])),128))]),V(n("div",nt,[n("div",at,[lt,D(_e,{class:"group-detail-sys-modal-ipt",placeholder:"请输入指令",modelValue:h.value,"onUpdate:modelValue":e[0]||(e[0]=s=>h.value=s),autocomplete:"off"},null,8,["modelValue"]),n("div",it,[n("button",{onClick:e[1]||(e[1]=s=>a.value=!1)},"取消"),n("button",{onClick:C},"保存")])])],512),[[N,a.value]]),V(n("div",{class:"ds-chat-more-opactions",style:F({left:`${K.value.x}px`,top:`${K.value.y}px`})},[n("dl",{onClick:T(B,["stop"])},"复制"),n("dl",{onClick:T(I,["stop"])},"手动复制"),n("dl",{style:{color:"red"},onClick:T(u,["stop"])},"删除")],4),[[N,f.value]])]))}}),ct=Q(ut,[["__scopeId","data-v-11dd6723"]]),rt={key:0,class:"chat-title"},dt={class:"chat-content-list"},pt=["id","onContextmenu"],vt={key:0,class:"chat-content-reason"},mt=["onClick"],yt={class:"chat-content-content"},kt=["innerHTML"],ht=Y({__name:"DeepSeekChat",props:{group:{},chat:{},streamKey:{},streamReason:{},streamContent:{}},emits:["reCreate","modifyContent"],setup(b,{emit:k}){const E=p(),y=k,r=b,{chat:c}=fe(r),{dbtool:v}=oe("ds"),l=p([]),a=p(null),h=p({x:0,y:0}),f=(t,i)=>{a.value=t,h.value={x:i.clientX,y:i.clientY}},K=()=>{v.getContentListByGhatKey(c.value.key).then(t=>{t.success&&(l.value=t.data||[],l.value.length>0&&Z(()=>{var i;(i=document.getElementById(`chatRecord_${l.value[l.value.length-1].key}`))==null||i.scrollIntoView({block:"end"})}))})},O=()=>{a.value&&v.deleteContent(a.value.key).then(()=>{K()})},g=()=>{a.value&&navigator.clipboard.writeText(a.value.content).then(()=>{$.success("复制成功")})},u=()=>{if(a.value){a.value.isStream=!0;const t=l.value.slice(0,l.value.length-1).map(i=>({role:i.role,content:i.content}));r.group.sysPreset&&t.unshift({role:"system",content:r.group.sysPreset}),y("reCreate",a.value,t),a.value=null}},B=async()=>{a.value&&l.value[l.value.length-1]&&(y("modifyContent",a.value,l.value[l.value.length-1]),Z(()=>{a.value=null}))};j(()=>r.streamKey,()=>{K()}),j([()=>r.streamReason+r.streamContent],()=>{Z(()=>{var C;const t=document.getElementById(`chatRecord_${r.streamKey}`),i=(C=t==null?void 0:t.parentElement)==null?void 0:C.parentElement;i&&i.scrollHeight-68<=i.offsetHeight+i.scrollTop&&(console.log(i.scrollHeight-10,i.offsetHeight,i.scrollTop,i.offsetHeight+i.scrollTop),t.scrollIntoView({block:"end"}))})}),K();const I=()=>{a.value=null};return se(()=>{window.addEventListener("click",I)}),ne(()=>{window.removeEventListener("click",I)}),(t,i)=>{var C,M,P,o;return d(),m("div",{ref_key:"contentScroll",ref:E,class:"ds-chat"},[L(c).name?(d(),m("div",rt,U(L(c).name),1)):G("",!0),n("div",dt,[(d(!0),m(z,null,ae(l.value,e=>V((d(),m("div",{class:ee(["chat-content-item",`chat-content-item--${e.role}`]),key:e.key,id:`chatRecord_${e.key}`,onContextmenu:T(s=>f(e,s),["prevent"])},[e.role==="assistant"&&(e.reason||e.key===t.streamKey&&t.streamReason)?(d(),m("div",vt,[n("div",{style:{"line-height":"22px"},onClick:s=>e.reasonOpen=!e.reasonOpen},[R(" 思考过程 "),D(Ie,{class:ee({"reason-open":e.reasonOpen})},null,8,["class"])],8,mt),V(D(ve,{content:e.key===t.streamKey?t.streamReason:e.reason||"",disabledTypes:["a"],theme:"dark"},null,8,["content"]),[[N,e.reasonOpen]])])):G("",!0),n("div",yt,[e.role==="user"?(d(),m("div",{key:0,innerHTML:e.content.replace(`
`,"<br />")},null,8,kt)):(d(),X(ve,{key:1,content:e.key===t.streamKey?t.streamContent:e.content||"",disabledTypes:["a"],theme:"dark"},null,8,["content"]))])],42,pt)),[[L(ge),{handler:s=>{f(e,s)},triggerTime:1e3}]])),128))]),V(n("div",{class:"ds-content-more-opactions",style:F({left:`${h.value.x}px`,top:`${h.value.y}px`})},[n("dl",{onClick:i[0]||(i[0]=e=>g())},"复制"),((C=a.value)==null?void 0:C.role)==="user"&&a.value.key===((M=l.value[l.value.length-1])==null?void 0:M.userContentKey)?(d(),m("dl",{key:0,onClick:T(B,["stop"])}," 修改 ")):G("",!0),((P=a.value)==null?void 0:P.role)==="assistant"&&l.value[l.value.length-1].key===a.value.key?(d(),m("dl",{key:1,onClick:T(u,["stop"])}," 重新生成 ")):G("",!0),((o=a.value)==null?void 0:o.role)==="user"?(d(),m("dl",{key:2,style:{color:"red"},onClick:T(O,["stop"])},"删除")):G("",!0)],4),[[N,a.value]])],512)}}}),ft=Q(ht,[["__scopeId","data-v-9a612e1c"]]),gt={class:"deepseek"},Ct={class:"deepseek-list"},_t={class:"deepseek-sider-btns"},$t={key:1,class:"deepseek-sider"},bt={class:"deepseek-list"},Kt={class:"deepseek-sider-btns"},St={class:"deepseek-container"},xt={class:"ds-send-btns"},wt=["disabled"],Tt=Y({__name:"DeepSeek",setup(b){const k=ye(),E=te(),y=new De,r=p(null),c=p(null),v=p(!1),l=p(""),a=p(window.innerWidth<=750),h=p(!1),f=p(""),K=p([]);Te("ds",{dbtool:y});const O=o=>{r.value=o},g=de({});y.getConfig().then((o=[])=>{o.forEach(s=>g[s.name]=s.value);const e=g.aiType||"deepseek";fetch(`${q[e]}/models`,{method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${g[W[e]]}`,mode:"no-cors"}}).then(s=>s.json()).then(s=>{K.value=((s==null?void 0:s.data)||[]).map(_=>_.id),f.value=Ve[e]||K.value[0]})}),j([v],()=>{v.value||y.getConfig().then((o=[])=>{o.forEach(e=>g[e.name]=e.value)})});const u=de({content:"",reasoning:"",key:0,firstChatKey:0}),B=(o,e=3)=>{const s=g.aiType||"deepseek";let _="";fetch(`${q[s]}/chat/completions`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${g[W[s]]}`,mode:"no-cors"},body:JSON.stringify({messages:o,model:f.value,max_tokens:+g.maxToken||pe[s],stream:!0,temperature:.7,top_p:.9})}).then(S=>{var x;if(S.ok){const H=(x=S.body)==null?void 0:x.getReader(),J=new TextDecoder;u.content="",u.reasoning="";const le=async()=>{var ie,ue;const{value:be,done:Ke}=await H.read();if(Ke){if(!u.reasoning&&/^[\s\n]*<think>([\s\S]+)<\/think>([\s\S]*)/.test(u.content)){const w=u.content.match(/^[\s\n]*<think>([\s\S]+)<\/think>([\s\S]*)/);w&&w.length>=3&&(u.reasoning=w[1].replace(/(^[\s\n]+|[\s\n]+$)/g,""),u.content=w[2].replace(/(^[\s\n]+|[\s\n]+$)/g,""))}g[W.nebulablock]&&u.firstChatKey&&C(u.content),y.updateChat(c.value.key,{lastMsg:u.content}),y.updateContent(u.key,{content:u.content,reason:u.reasoning,isStream:!1}).then(w=>{w.success&&(u.key=0,u.content="",u.reasoning="")});return}const Se=_+J.decode(be,{stream:!0});_="";const xe=Se.split(`
`).filter(w=>w.trim());for(const w of xe)if(w.startsWith("data:")){const ce=w.replace("data:","").trim();if(ce==="[DONE]")continue;try{const A=(ue=(ie=JSON.parse(ce).choices)==null?void 0:ie[0])==null?void 0:ue.delta;A!=null&&A.content&&(u.content+=A.content),A!=null&&A.reasoning_content&&(u.reasoning+=A.reasoning_content)}catch(re){_+=w,console.error("解析错误:",re)}}le()};le()}else S.status===429&&e>0&&setTimeout(()=>{B(o,e-1)},1e3)}).catch(S=>{console.log(S,"err")})},I=(o,e)=>{y.updateContent(o.key,{content:"",reason:"",isStream:!0}),u.key=o.key,u.content="",u.reasoning="",B(e)},t=p({userContent:null,assContent:null}),i=async(o,e)=>{o.content&&(l.value=o.content,t.value={userContent:o,assContent:e})},C=o=>{fetch(`${q.edgefn}/chat/completions`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${g[W.edgefn]}`,mode:"no-cors"},body:JSON.stringify({messages:[{role:"user",content:`精简提炼以下对话的标题，直接输出提炼后的标题，不要输出其他文字
${o}`}],model:"DeepSeek-R1-0528-Qwen3-8B",max_tokens:pe.nebulablock,stream:!1})}).then(e=>e.json()).then(e=>{var s,_,S;y.updateChat(u.firstChatKey,{name:((S=(_=(s=e==null?void 0:e.choices)==null?void 0:s[0])==null?void 0:_.message)==null?void 0:S.content)||""}).then(()=>{var x,H,J;c.value&&(c.value.name=((J=(H=(x=e==null?void 0:e.choices)==null?void 0:x[0])==null?void 0:H.message)==null?void 0:J.content)||"")})}).finally(()=>{u.firstChatKey=0})},M=()=>{var o,e,s,_,S;l.value&&y.sendChatContent({content:l.value.replace(/(^\s+|\s+$)/g,""),groupKey:r.value.key,chatKey:((o=c.value)==null?void 0:o.key)??void 0,assContentKey:(s=(e=t.value)==null?void 0:e.assContent)==null?void 0:s.key,userContentKey:(S=(_=t.value)==null?void 0:_.userContent)==null?void 0:S.key}).then(x=>{x.success&&(l.value="",u.key=x.data.contentKey,B(x.data.historyContent),k.params.chatKey||(u.firstChatKey=x.data.chatKey,E.push({name:"tool-deepseek",params:{groupKey:r.value.key,chatKey:x.data.chatKey}})),t.value.userContent&&(t.value={userContent:null,assContent:null}))})},P=o=>{o.shiftKey||(o.preventDefault(),M())};return j(()=>k.params.groupKey,()=>{k.params.groupKey?y.getGroup(+k.params.groupKey).then(o=>{o||E.push({name:"tool-deepseek"}),r.value=o}):r.value=null},{immediate:!0}),j(()=>k.params.chatKey,()=>{k.params.chatKey?y.getChat(+k.params.chatKey).then(o=>{o||E.push({name:"tool-deepseek",params:{groupKey:k.params.groupKey}}),c.value=o}):c.value=null},{immediate:!0}),(o,e)=>(d(),m("div",gt,[a.value?V((d(),m("div",{key:0,class:"deepseek-mask",onClick:e[2]||(e[2]=s=>h.value=!1)},[n("div",{class:"deepseek-sider",onClick:e[1]||(e[1]=T(()=>{},["stop"]))},[n("div",Ct,[D(me)]),n("div",_t,[n("dl",{class:"deepseek-sider-btn",onClick:e[0]||(e[0]=s=>v.value=!0)},"设置")])])],512)),[[N,h.value]]):(d(),m("div",$t,[n("div",bt,[D(me)]),n("div",Kt,[n("dl",{class:"deepseek-sider-btn",onClick:e[3]||(e[3]=s=>v.value=!0)},"设置")])])),n("div",St,[a.value?(d(),X(Me,{key:0,color:"#fff",onClick:e[4]||(e[4]=s=>h.value=!0)})):G("",!0),L(k).params.chatKey?(d(),m(z,{key:1},[c.value&&r.value?(d(),X(ft,{key:0,chat:c.value,group:r.value,streamContent:u.content,streamReason:u.reasoning,"stream-key":u.key,onReCreate:I,onModifyContent:i},null,8,["chat","group","streamContent","streamReason","stream-key"])):G("",!0)],64)):L(k).params.groupKey?(d(),m(z,{key:2},[r.value?(d(),X(ct,{key:0,group:r.value,onGroupUpdate:O},null,8,["group"])):G("",!0)],64)):G("",!0),L(k).params.groupKey?(d(),m("div",{key:3,style:F({zIndex:t.value.userContent?99999999:0}),onClick:e[7]||(e[7]=T(()=>{},["stop"]))},[D(_e,{resize:"vertical",rows:3,placeholder:L(k).params.chatKey?"在这里发送消息":"在这里提问新建对话",modelValue:l.value,"onUpdate:modelValue":e[5]||(e[5]=s=>l.value=s),onEnter:P},null,8,["placeholder","modelValue"]),n("div",xt,[D(Oe,{modelValue:f.value,"onUpdate:modelValue":e[6]||(e[6]=s=>f.value=s),options:K.value.map(s=>({label:s,value:s}))},null,8,["modelValue","options"]),n("button",{disabled:!l.value,class:"ds-send-btn",onClick:T(M,["stop"])},"发送",8,wt)])],4)):G("",!0)]),D(Ee,{config:g,modelValue:v.value,"onUpdate:modelValue":e[8]||(e[8]=s=>v.value=s)},null,8,["config","modelValue"]),V(n("div",{class:"deepseek-mask",onClick:e[9]||(e[9]=()=>{t.value={userContent:null,assContent:null},l.value=""})},null,512),[[N,t.value.userContent]])]))}}),Ht=Q(Tt,[["__scopeId","data-v-352da7eb"]]);export{Ht as default};
