import{d as K,a as v,r as H,j as Q,y as W,o as r,b as i,F as $,e as m,f as u,w as y,l as X,E as U,n as b,z as L,m as Y,t as k,s as Z,G as O,v as ee,p as te,g as oe,_ as ae}from"./index-C8_KvqLc.js";import{M as T}from"./MjInput-dmF8qiW0.js";import{_ as le}from"./MjTree.vue_vue_type_style_index_0_lang-C1u82sRu.js";import{M as w}from"./MjButton-BmN55pLQ.js";import{_ as ne}from"./MjMd.vue_vue_type_style_index_0_lang-Ca3UJ58x.js";import{_ as se}from"./MjPre.vue_vue_type_style_index_0_lang-C0WN2G5J.js";import{M as re}from"./MjSlider-CnvDmUfS.js";import{_ as ce}from"./CloseIcon.vue_vue_type_script_setup_true_lang-BO1-knco.js";import"./RightIcon.vue_vue_type_script_setup_true_lang-BCkZ8AjK.js";import"./DownIcon.vue_vue_type_script_setup_true_lang-CXD0Fd_i.js";import"./LoadingIcon.vue_vue_type_script_setup_true_lang-Cjl4ccjb.js";import"./index-C1s-hTSf.js";import"./MjMessage-B6PxiNxc.js";const ie=S=>(te("data-v-f2549f42"),S=S(),oe(),S),ue={key:0,class:"file-brower"},pe={class:"file-wrapper"},ve={class:"file-content"},ge={class:"file-content-tabs-wrapper"},_e={class:"file-content-tabs"},he=["onClick"],fe={key:0,class:"file-content-show"},me=["src"],de=["src"],ye=["src"],ke=ie(()=>m("br",null,null,-1)),we={key:1,class:"file-brower"},Se=K({__name:"GiteeBase64Perview",setup(S){const{query:{opacity:P,code:x}}=Y();let g={url:"",tree:[]};try{g=JSON.parse(localStorage.getItem("getee_tree")||"")}catch(t){console.log(t)}const p=v(localStorage.getItem("gitee_access_token")||""),R=()=>{const t=localStorage.getItem("gitee_refresh_token");t&&fetch("https://gitee.com/oauth/token",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({grant_type:"refresh_token",refresh_token:t})}).then(e=>e.json()).then(e=>{p.value=e.access_token,localStorage.setItem("gitee_access_token",e.access_token),localStorage.setItem("gitee_refresh_token",e.refresh_token),localStorage.setItem("gitee_token_expires",((e.created_at+e.expires_in-600)*1e3).toString())}).catch(()=>{console.error("刷新令牌失败")})};localStorage.getItem("gitee_access_token")&&(!localStorage.getItem("gitee_token_expires")||Date.now()>=Number(localStorage.getItem("gitee_token_expires")))&&(localStorage.getItem("gitee_refresh_token")?R():(localStorage.removeItem("gitee_access_token"),localStorage.removeItem("gitee_refresh_token"),localStorage.removeItem("gitee_token_expires"),p.value=""));const d=v((g==null?void 0:g.url)||""),_=v(localStorage.getItem("gitee_client_id")||""),f=v(localStorage.getItem("gitee_client_secret")||""),V=()=>{if(_.value&&f.value)if(x){const t=new URLSearchParams({grant_type:"authorization_code",code:x,client_id:_.value,redirect_uri:`${window.location.origin}${window.location.pathname}`,client_secret:f.value}).toString();fetch("https://gitee.com/oauth/token?"+t,{method:"POST",headers:{"Content-Type":"application/json"}}).then(e=>e.json()).then(e=>{p.value=e.access_token,localStorage.setItem("gitee_access_token",e.access_token),localStorage.setItem("gitee_refresh_token",e.refresh_token),localStorage.setItem("gitee_token_expires",((e.created_at+e.expires_in-600)*1e3).toString())}).catch(()=>{console.error("登录失败")})}else localStorage.setItem("gitee_client_id",_.value),localStorage.setItem("gitee_client_secret",f.value),window.location.href=`https://gitee.com/oauth/authorize?client_id=${_.value}&redirect_uri=${encodeURIComponent(`${window.location.origin}${window.location.pathname}`)}&response_type=code`};_.value&&f.value&&!p.value&&x&&V();const j=()=>{localStorage.removeItem("gitee_access_token"),localStorage.removeItem("gitee_refresh_token"),p.value=""},I=v([]),n=v([]),o=v(""),a=v({}),z=()=>{I.value=[],n.value=[],o.value="",a.value={}},G=t=>{o.value=t},F=()=>{n.value=[],o.value=""},N=t=>{const e=n.value.indexOf(t);e>-1&&(e>0?o.value=n.value[e-1]:n.value.length>1?o.value=n.value[e+1]:o.value="",n.value.splice(e,1),delete a.value[t])},B=t=>{const e={},l=[];t.forEach(s=>{const h=s.path.split("/"),M=h.slice(0,h.length-1).join("/"),C={title:h[h.length-1],path:s.path,isLeaf:s.type!=="tree",key:s.sha,children:[]};s.type==="tree"&&(e[s.path]=C),e[M]?e[M].children.push(s.type==="tree"?e[s.path]:C):l.push(s.type==="tree"?e[s.path]:C)}),I.value=l},c=H({owner:"",repo:"",branch:""}),A=()=>{const t=d.value.match(/^https:\/\/gitee.com\/([^/]+)\/([^/]+)\/([^/]+)/);if(c.owner=(t==null?void 0:t[1])||"",c.repo=(t==null?void 0:t[2])||"",c.branch=(t==null?void 0:t[3])||"",g.url===d.value&&g.tree.length>0){B(g.tree);return}fetch(`https://gitee.com/api/v5/repos/${c.owner}/${c.repo}/git/trees/${c.branch}?access_token=${p.value}&recursive=1`,{method:"GET",headers:{"Content-Type":"application/json"}}).then(e=>{if(e.ok)return e.json();throw new Error("Network response was not ok")}).then(e=>{const l=e.tree.map(s=>({path:s.path,sha:s.sha,type:s.type}));l.sort((s,h)=>s.type===h.type?s.path.localeCompare(h.path):s.type==="tree"?-1:1),localStorage.setItem("getee_tree",JSON.stringify({tree:l,url:d.value})),B(l)}).catch(()=>{console.error("转换失败")})},D=async()=>{A()},J=async t=>await fetch(`https://gitee.com/api/v5/repos/${c.owner}/${c.repo}/raw/${encodeURIComponent(t)}?access_token=${p.value}&ref=${c.branch}`,{method:"GET"}).then(e=>{if(e.ok)return e.text();throw new Error("Network response was not ok")}),q=async t=>{if(t.isLeaf){if(n.value.includes(t.key)){o.value=t.key;return}const e={type:"text",lang:"",name:t.title,content:"",key:t.key,opacity:100};if(/\.(ico|jpg|jpeg|png|webp|gif)$/.test(t.title))e.type="url",e.content=`https://gitee.com/api/v5/repos/${c.owner}/${c.repo}/raw/${encodeURIComponent(t.path)}?access_token=${p.value}&ref=${c.branch}`,e.opacity=100,a.value[t.key]=e,n.value.push(t.key),o.value=t.key;else{const l=await J(t.path);e.content=l,/\.md$/.test(t.title)?(e.type="md",e.opacity=100):(e.opacity=+(P||"0"),e.type="text"),/\.css$/.test(t.title)?e.lang="css":e.lang="",a.value[t.key]=e,n.value.push(t.key),o.value=t.key}}},E=t=>{switch(t.key){case"ArrowLeft":if(o.value&&n.value.length>0){const e=n.value.indexOf(o.value);e>0?o.value=n.value[e-1]:o.value=n.value[n.value.length-1]}break;case"ArrowRight":if(o.value&&n.value.length>0){const e=n.value.indexOf(o.value);e<n.value.length-1?o.value=n.value[e+1]:o.value=n.value[0]}break;case"Backspace":N(o.value);break}};return Q(()=>{window.addEventListener("keyup",E)}),W(()=>{window.removeEventListener("keyup",E)}),(t,e)=>p.value?(r(),i("div",ue,[I.value.length>0?(r(),i($,{key:0},[m("div",pe,[u(le,{data:I.value,"bg-color":"rgb(24,24,24)","text-color":"rgb(204,204,204)","load-more":q},null,8,["data"]),u(w,{onClick:z},{default:y(()=>[k("清空")]),_:1}),u(w,{onClick:j},{default:y(()=>[k("退出登录")]),_:1})]),m("div",ve,[m("div",ge,[m("div",_e,[(r(!0),i($,null,X(n.value,l=>(r(),i("div",{class:Z({"file-content-tab":!0,"file-content-tab--active":l===o.value}),key:l,onClick:s=>G(l),onContextmenu:O(F,["prevent"])},[m("span",null,ee(a.value[l].name),1),u(ce,{onClick:O(s=>N(l),["stop"])},null,8,["onClick"])],42,he))),128))])]),o.value&&a.value[o.value]?(r(),i("div",fe,[a.value[o.value].type==="url"?(r(),i("img",{key:0,src:a.value[o.value].content},null,8,me)):a.value[o.value].type==="md"?(r(),U(ne,{key:1,content:a.value[o.value].content},null,8,["content"])):a.value[o.value].type==="text"?(r(),i($,{key:2},[u(re,{"active-color":"orange",style:{"margin-left":"20px",width:"200px"},modelValue:a.value[o.value].opacity,"onUpdate:modelValue":e[0]||(e[0]=l=>a.value[o.value].opacity=l)},null,8,["modelValue"]),/^data:image\/[^;]*;base64,/.test(a.value[o.value].content)?(r(),i("img",{key:0,src:a.value[o.value].content,style:b({opacity:a.value[o.value].opacity/100})},null,12,de)):/^https?:\/\/.+\.(jpg|jpeg|png|svg|bmpgif|webp)/.test(a.value[o.value].content)?(r(),i("img",{key:1,src:a.value[o.value].content,style:b({opacity:a.value[o.value].opacity/100})},null,12,ye)):(r(),U(se,{key:2,value:a.value[o.value].content,lang:a.value[o.value].lang,style:b({opacity:a.value[o.value].opacity/100})},null,8,["value","lang","style"]))],64)):L("",!0)])):L("",!0)])],64)):(r(),i($,{key:1},[u(T,{modelValue:d.value,"onUpdate:modelValue":e[1]||(e[1]=l=>d.value=l),placeholder:"gitee仓库地址"},null,8,["modelValue"]),ke,u(w,{onClick:D},{default:y(()=>[k("打开仓库")]),_:1}),u(w,{onClick:j},{default:y(()=>[k("退出登录")]),_:1})],64))])):(r(),i("div",we,[u(T,{modelValue:_.value,"onUpdate:modelValue":e[2]||(e[2]=l=>_.value=l),placeholder:"client_id",style:{width:"calc(50% - 60px)"}},null,8,["modelValue"]),u(T,{modelValue:f.value,"onUpdate:modelValue":e[3]||(e[3]=l=>f.value=l),placeholder:"client_secret",style:{width:"calc(50% - 60px)"}},null,8,["modelValue"]),u(w,{onClick:V},{default:y(()=>[k("登录")]),_:1})]))}}),Oe=ae(Se,[["__scopeId","data-v-f2549f42"]]);export{Oe as default};
