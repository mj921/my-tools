import{d as fe,Z as xe,m as we,a as f,i as Ge,j as Se,y as Le,o as v,b as _,e as a,t as ne,f as x,F as me,l as pe,s as ve,u as V,v as ee,G as I,C as B,D as F,H as Ke,n as he,p as Me,g as Te,_ as ye,$ as Ue,x as ae,z as E,w as te,A as ce,E as oe,r as re,h as Ee}from"./index-C8_KvqLc.js";import{D as Ie}from"./db-6kmVuVtA.js";import{_ as Ne,a as Oe,v as je,f as ke,d as Ae,D as Be,A as Ce,b as ge,e as _e}from"./aiConfig-Bu_ffJ7U.js";import{M as se}from"./MjTextarea-yOKFGuNi.js";import{M as ze}from"./MjSelect-CB5zIzi7.js";import{m as J}from"./MjMessage-B6PxiNxc.js";import{m as Je}from"./mjmodal-Dt-Lc6FC.js";import{_ as $e}from"./MjMd.vue_vue_type_style_index_0_lang-Ca3UJ58x.js";import{_ as He}from"./RightIcon.vue_vue_type_script_setup_true_lang-BCkZ8AjK.js";import{M as de}from"./index-D5Ao2_O2.js";import{M as We}from"./MjButton-BmN55pLQ.js";import{M as be}from"./MjInput-dmF8qiW0.js";import{_ as Fe}from"./DownIcon.vue_vue_type_script_setup_true_lang-CXD0Fd_i.js";import"./MjModal-D8GbfQV7.js";import"./CloseIcon.vue_vue_type_script_setup_true_lang-BO1-knco.js";import"./index-C1s-hTSf.js";import"./LoadingIcon.vue_vue_type_script_setup_true_lang-Cjl4ccjb.js";const Pe=K=>(Me("data-v-627844a4"),K=K(),Te(),K),Xe={class:"ds-group"},Ye={class:"ds-group-header"},Ze={class:"ds-group-list"},qe=["onClick"],Qe={class:"deepseek-mask"},Re={class:"ds-group-modal"},et=Pe(()=>a("div",{class:"ds-group-modal-header"},"群聊",-1)),tt={class:"ds-group-modal-card"},st={class:"ds-group-modal-row"},nt=Pe(()=>a("label",{class:"ds-group-modal-label",for:"ds-groupname"},"名称",-1)),at={class:"ds-group-modal-btns"},ot=fe({__name:"DSGroupChatList",setup(K){const U=xe(),q=we(),w=f([]),{dbtool:u}=Ge("ds"),h=f(!1),o=f(""),S=f(0),i=f(null),c=f({x:0,y:0}),z=()=>{S.value?u.updateGroupChat({key:S.value,name:o.value}).then(n=>{n!=null&&n.success?J.success((n==null?void 0:n.msg)||"编辑成功"):J.error((n==null?void 0:n.msg)||"编辑失败")}):u.addGroupChat(o.value).then(n=>{n!=null&&n.success?J.success((n==null?void 0:n.msg)||"添加成功"):J.error((n==null?void 0:n.msg)||"添加失败")}),h.value=!1,u.getGroupChatList().then(n=>{w.value=n})},X=()=>{h.value=!0,S.value=0,o.value=""},$=()=>{i.value&&(h.value=!0,S.value=i.value.key,o.value=i.value.name,i.value=null)},l=()=>{i.value&&(S.value=i.value.key,i.value=null,Je.confirm({title:"删除",content:"是否确定删除"}).then(()=>{u.deleteGroupChat(S.value).then(n=>{n!=null&&n.success?(J.success((n==null?void 0:n.msg)||"删除成功"),u.getGroupChatList().then(G=>{w.value=G})):J.error((n==null?void 0:n.msg)||"删除失败")})}).catch(n=>{console.log(n)}).finally(()=>{S.value=0}))},N=n=>{U.push({name:"tool-ds-groupchat",params:{chatKey:n}})},O=(n,G)=>{i.value=n,c.value={x:G.clientX,y:G.clientY}};u.getGroupChatList().then(n=>{w.value=n});const y=()=>{i.value=null};return Se(()=>{window.addEventListener("click",y)}),Le(()=>{window.removeEventListener("click",y)}),(n,G)=>(v(),_("div",Xe,[a("dt",Ye,[ne("群聊 "),x(Ne,{onClick:X})]),a("div",Ze,[(v(!0),_(me,null,pe(w.value,k=>(v(),_("dl",{class:ve(["ds-group-item",{"ds-group-item--active":k.key.toString()===V(q).params.chatKey}]),key:k.key,onClick:Y=>N(k.key)},[ne(ee(k.name)+" ",1),x(Oe,{onClick:I(Y=>O(k,Y),["stop"])},null,8,["onClick"])],10,qe))),128))]),B(a("div",Qe,[a("div",Re,[et,a("div",tt,[a("dl",st,[nt,B(a("input",{class:"ds-group-modal-ipt",id:"ds-groupname",placeholder:"请输入群聊名称","onUpdate:modelValue":G[0]||(G[0]=k=>o.value=k),autocomplete:"off"},null,512),[[Ke,o.value]])])]),a("div",at,[a("button",{onClick:G[1]||(G[1]=k=>h.value=!1)},"取消"),a("button",{onClick:z},"保存")])])],512),[[F,h.value]]),B(a("div",{class:"ds-group-more-opactions",style:he({left:`${c.value.x}px`,top:`${c.value.y}px`})},[a("dl",{onClick:$},"编辑名称"),a("dl",{style:{color:"red"},onClick:l},"删除")],4),[[F,i.value]])]))}}),Ve=ye(ot,[["__scopeId","data-v-627844a4"]]),De=K=>(Me("data-v-5cfa1729"),K=K(),Te(),K),lt={key:0,class:"chat-title"},ut={class:"ds-groupchat-info"},it={class:"ds-groupchat-sys"},ct={class:"chat-content-list"},rt=["id","onContextmenu"],dt={key:0,class:"chat-content-name"},mt={key:1,class:"chat-content-reason"},pt=["onClick"],vt={class:"chat-content-content"},ft=["innerHTML"],ht={class:"deepseek-mask"},yt={class:"ds-groupchat-sys-modal"},kt=De(()=>a("div",{class:"ds-groupchat-sys-modal-header"},"设置指令",-1)),Ct={class:"ds-groupchat-sys-modal-btns"},gt={key:1,class:"deepseek-mask"},_t={class:"ds-groupchat-sys-modal"},$t=De(()=>a("div",{class:"ds-groupchat-sys-modal-header"},"群成员",-1)),bt=fe({__name:"DSGroupChatDetail",props:{chat:{},streamKey:{},streamReason:{},streamContent:{}},emits:["reCreate","modifyContent","chatUpdate","refreshGroupchat"],setup(K,{expose:U,emit:q}){const w=f(),u=q,h=K,{chat:o}=Ue(h),{dbtool:S}=Ge("ds"),i=f([]),c=f(null),z=f({x:0,y:0}),X=(d,e)=>{c.value=d,z.value={x:e.clientX,y:e.clientY}},$=()=>{S.getGroupContentListByGhatKey(o.value.key).then(d=>{d.success&&(i.value=d.data||[],i.value.length>0&&ce(()=>{var e;(e=document.getElementById(`chatRecord_${i.value[i.value.length-1].key}`))==null||e.scrollIntoView({block:"end"})}))})},l=()=>{c.value&&S.deleteContent(c.value.key).then(()=>{$()})},N=()=>{c.value&&navigator.clipboard.writeText(c.value.content).then(()=>{J.success("复制成功")})},O=()=>{if(c.value){c.value.isStream=!0;const d=i.value.slice(0,i.value.length-1).map(e=>({role:e.role,content:e.content}));h.chat.sysPreset&&d.unshift({role:"system",content:h.chat.sysPreset}),u("reCreate",c.value,d),c.value=null}},y=async()=>{c.value&&i.value[i.value.length-1]&&(u("modifyContent",c.value,i.value[i.value.length-1]),ce(()=>{c.value=null}))};ae(()=>h.streamKey,()=>{$()}),ae([()=>h.streamReason+h.streamContent],()=>{ce(()=>{var d;(d=document.getElementById(`chatRecord_${h.streamKey}`))==null||d.scrollIntoView({block:"end"})})}),$();const n=()=>{c.value=null},G=f(!1),k=f(""),Y=()=>{k.value=o.value.sysPreset,G.value=!0},Q=()=>{S.updateGroupChat({key:o.value.key,name:o.value.name,sysPreset:k.value}).then(()=>{G.value=!1,u("chatUpdate",{...o.value,sysPreset:k.value}),k.value=""})},Z=f(!1),le=()=>{const d=o.value.memberList||[],e=Math.max(0,...d.filter(t=>/^未命名\d+$/.test(t.name)).map(t=>+t.name.replace("未命名","")));d.push({name:`未命名${e+1}`,sysPreset:""}),o.value.memberList=d},ue=()=>{Z.value=!1,u("refreshGroupchat")},ie=()=>{const d=[];let e="";(o.value.memberList||[]).forEach(t=>{d.includes(t.name)?e=t.name:d.push(t.name)}),e?J.error(`${e}已存在`):S.updateGroupChat(o.value).then(()=>{Z.value=!1,u("refreshGroupchat")})};return U({getContentList:$}),Se(()=>{window.addEventListener("click",n)}),Le(()=>{window.removeEventListener("click",n)}),(d,e)=>{var t,r,p,m,D;return v(),_("div",{ref_key:"contentScroll",ref:w,class:"ds-chat"},[V(o).name?(v(),_("div",lt,ee(V(o).name),1)):E("",!0),a("div",ut,[a("div",it,[a("div",{class:"ds-groupchat-sys-text",onClick:Y},ee(V(o).sysPreset||"添加指令"),1),x(He)]),a("div",{onClick:e[0]||(e[0]=s=>Z.value=!0),style:{flex:"0","white-space":"nowrap"}},ee(((t=V(o).memberList)==null?void 0:t.length)||0)+"人 ",1)]),a("div",ct,[(v(!0),_(me,null,pe(i.value,s=>B((v(),_("div",{class:ve(["chat-content-item",`chat-content-item--${s.role}`]),key:s.key,id:`chatRecord_${s.key}`,onContextmenu:I(C=>X(s,C),["prevent"])},[s.name?(v(),_("div",dt,ee(s.name),1)):E("",!0),s.role==="assistant"&&(s.reason||s.key===d.streamKey&&d.streamReason)?(v(),_("div",mt,[a("div",{style:{"line-height":"22px"},onClick:C=>s.reasonOpen=!s.reasonOpen},[ne(" 思考过程 "),x(Fe,{class:ve({"reason-open":s.reasonOpen})},null,8,["class"])],8,pt),B(x($e,{content:s.key===d.streamKey?d.streamReason:s.reason||"",disabledTypes:["a"],theme:"dark"},null,8,["content"]),[[F,s.reasonOpen]])])):E("",!0),a("div",vt,[s.role==="user"?(v(),_("div",{key:0,innerHTML:s.content.replace(`
`,"<br />")},null,8,ft)):(v(),oe($e,{key:1,content:s.key===d.streamKey?d.streamContent:s.content||"",disabledTypes:["a"],theme:"dark"},null,8,["content"]))])],42,rt)),[[V(je),{handler:C=>{X(s,C)},triggerTime:1e3}]])),128))]),B(a("div",{class:"ds-content-more-opactions",style:he({left:`${z.value.x}px`,top:`${z.value.y}px`})},[a("dl",{onClick:e[1]||(e[1]=s=>N())},"复制"),((r=c.value)==null?void 0:r.role)==="user"&&c.value.key===((p=i.value[i.value.length-1])==null?void 0:p.userContentKey)?(v(),_("dl",{key:0,onClick:I(y,["stop"])}," 修改 ")):E("",!0),((m=c.value)==null?void 0:m.role)==="assistant"&&i.value[i.value.length-1].key===c.value.key?(v(),_("dl",{key:1,onClick:I(O,["stop"])}," 重新生成 ")):E("",!0),((D=c.value)==null?void 0:D.role)==="user"?(v(),_("dl",{key:2,style:{color:"red"},onClick:I(l,["stop"])},"删除")):E("",!0)],4),[[F,c.value]]),B(a("div",ht,[a("div",yt,[kt,x(se,{class:"ds-groupchat-sys-modal-ipt",placeholder:"请输入指令",modelValue:k.value,"onUpdate:modelValue":e[2]||(e[2]=s=>k.value=s),autocomplete:"off"},null,8,["modelValue"]),a("div",Ct,[a("button",{onClick:e[3]||(e[3]=s=>G.value=!1)},"取消"),a("button",{onClick:Q},"保存")])])],512),[[F,G.value]]),Z.value?(v(),_("div",gt,[a("div",_t,[$t,x(We,{onClick:le},{default:te(()=>[ne("添加")]),_:1}),x(V(de),{defaultActiveKey:"主角"},{default:te(()=>[x(V(de).Panel,{title:"主角",key:"主角"},{default:te(()=>[x(be,{modelValue:V(o).username,"onUpdate:modelValue":e[4]||(e[4]=s=>V(o).username=s)},null,8,["modelValue"]),x(se,{class:"ds-groupchat-sys-modal-ipt",placeholder:"请输入指令",modelValue:V(o).userPreset,"onUpdate:modelValue":e[5]||(e[5]=s=>V(o).userPreset=s),autocomplete:"off"},null,8,["modelValue"])]),_:1}),(v(!0),_(me,null,pe(V(o).memberList||[],(s,C)=>(v(),oe(V(de).Panel,{title:s.name,key:C.toString()},{default:te(()=>[x(be,{modelValue:s.name,"onUpdate:modelValue":L=>s.name=L},null,8,["modelValue","onUpdate:modelValue"]),x(se,{class:"ds-groupchat-sys-modal-ipt",placeholder:"请输入指令",modelValue:s.sysPreset,"onUpdate:modelValue":L=>s.sysPreset=L,autocomplete:"off"},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1032,["title"]))),128))]),_:1}),a("div",{class:"ds-groupchat-sys-modal-btns"},[a("button",{onClick:ue},"取消"),a("button",{onClick:ie},"保存")])])])):E("",!0)],512)}}}),Vt=ye(bt,[["__scopeId","data-v-5cfa1729"]]),xt={class:"deepseek"},wt={class:"deepseek-list"},Gt={class:"deepseek-sider-btns"},St={key:1,class:"deepseek-sider"},Lt={class:"deepseek-list"},Mt={class:"deepseek-sider-btns"},Tt={class:"deepseek-container"},Pt={class:"ds-send-btns"},Dt=["disabled"],Kt=fe({__name:"GroupChat",setup(K){const U=we(),q=xe(),w=new Ie,u=f(null),h=f(!1),o=f(""),S=f(window.innerWidth<=750),i=f(!1),c=f(""),z=f();Ee("ds",{dbtool:w});const X=e=>{u.value=e},$=re({});w.getConfig().then((e=[])=>{e.forEach(t=>$[t.name]=t.value),c.value=ke[$.aiType||"deepseek"][0]}),ae([h],()=>{h.value||w.getConfig().then((e=[])=>{e.forEach(t=>$[t.name]=t.value)})});const l=re({content:"",reasoning:"",key:0,firstChatKey:0,name:""}),N=f([]),O=f({}),y=re({name:"",content:""}),n=(e,t=3)=>{const r=$.aiType||"deepseek";let p="";fetch(`${Ce[r]}/chat/completions`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${$[ge[r]]}`,mode:"no-cors"},body:JSON.stringify({messages:e,model:c.value,max_tokens:+$.maxToken||_e[r],stream:!0,temperature:.7,top_p:.9})}).then(m=>{var D;if(m.ok){const s=(D=m.body)==null?void 0:D.getReader(),C=new TextDecoder;l.content="",l.reasoning="";const L=async()=>{var A,R;const{value:b,done:j}=await s.read();if(j){w.updateGroupContent(l.key,{content:l.content,reason:l.reasoning,isStream:!1}).then(M=>{if(M.success){O.value[l.name]=(O.value[l.name]||0)+1;const H=Object.values(O.value).reduce((W,g)=>W+g,0);y.content=l.content,l.key=0,l.content="",l.reasoning="",N.value.length>0||Math.random()<.618**H?Q():y.content=""}});return}const T=p+C.decode(b,{stream:!0});p="";const P=T.split(`
`).filter(M=>M.trim());for(const M of P)if(M.startsWith("data:")){const H=M.replace("data:","").trim();if(H==="[DONE]")continue;try{const g=(R=(A=JSON.parse(H).choices)==null?void 0:A[0])==null?void 0:R.delta;g!=null&&g.content&&(l.content+=g.content),g!=null&&g.reasoning_content&&(l.reasoning+=g.reasoning_content)}catch(W){p+=M,console.error("解析错误:",W)}}L()};L()}else m.status===429&&t>0&&setTimeout(()=>{n(e,t-1)},1e3)}).catch(m=>{console.log(m,"err")})},G=(e,t)=>{w.updateContent(e.key,{content:"",reason:"",isStream:!0}),l.key=e.key,l.content="",l.reasoning="",n(t)},k=f({userContent:null,assContent:null}),Y=async(e,t)=>{e.content&&(o.value=e.content,k.value={userContent:e,assContent:t})},Q=()=>{var t,r,p,m,D;const e=[...((t=u.value)==null?void 0:t.memberList)||[]];if(o.value&&(y.content=o.value,y.name=((r=u.value)==null?void 0:r.username)||"林"),y.content&&u.value&&e.length>0){e.forEach(b=>{y.content.includes(b.name)&&y.name!==b.name&&N.value.push(b.name)});let s=-1;if(N.value.length>0)s=e.findIndex(b=>b.name===N.value[0]),N.value.shift();else{const b=e.reduce((T,P)=>T+(P.name===y.name?0:1/((O.value[P.name]||0)+1)),0);let j=Math.random()*b;for(let T=0;T<e.length;T++)if(e[T].name!==y.name){const P=1/((O.value[e[T].name]||0)+1);j<P?s=T:j-=P}}if(s===-1)return;const C=e[s];l.name=C.name,e.splice(s,1);const L=(u.value.sysPreset?[u.value.sysPreset]:[]).concat(e.map(b=>`${b.name}:
${b.sysPreset}`)).concat([`我是${((p=u.value)==null?void 0:p.username)||"林"}
${((m=u.value)==null?void 0:m.userPreset)||""}`]).join(`
`);w.sendGroupChatContent(u.value.key,C.name,o.value?{role:"user",name:((D=u.value)==null?void 0:D.username)||"林",content:y.content}:void 0).then(b=>{var j,T;if(b.success){l.key=b.data.contentKey;const P=[{role:"system",content:L}];P.push(...b.data.list.map(A=>({role:A.role,name:A.name,content:A.content}))),P.push({role:"system",content:`你是${C.name}:
${C.sysPreset}`}),y.name===(((j=u.value)==null?void 0:j.username)||"林")&&P.push({role:"user",name:((T=u.value)==null?void 0:T.username)||"林",content:y.content}),y.name=C.name,o.value="",n(P)}})}},Z=(e,t=3)=>{const r=$.aiType||"deepseek";let p="";fetch(`${Ce[r]}/chat/completions`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${$[ge[r]]}`,mode:"no-cors"},body:JSON.stringify({messages:e,model:c.value,max_tokens:+$.maxToken||_e[r],stream:!0,temperature:.7,top_p:.9})}).then(m=>{var D;if(m.ok){const s=(D=m.body)==null?void 0:D.getReader(),C=new TextDecoder;l.content="",l.reasoning="";const L=async()=>{var A,R;const{value:b,done:j}=await s.read();if(j){w.updateGroupContent(l.key,{content:l.content,reason:l.reasoning,isStream:!1}).then(M=>{M.success&&(l.key=0,l.content="",l.reasoning="")});return}const T=p+C.decode(b,{stream:!0});p="";const P=T.split(`
`).filter(M=>M.trim());for(const M of P)if(M.startsWith("data:")){const H=M.replace("data:","").trim();if(H==="[DONE]")continue;try{const g=(R=(A=JSON.parse(H).choices)==null?void 0:A[0])==null?void 0:R.delta;g!=null&&g.content&&(l.content+=g.content),g!=null&&g.reasoning_content&&(l.reasoning+=g.reasoning_content)}catch(W){p+=M,console.error("解析错误:",W)}}L()};L()}else m.status===429&&t>0&&setTimeout(()=>{n(e,t-1)},1e3)}).catch(m=>{console.log(m,"err")})},le=()=>{var t,r;const e=[...((t=u.value)==null?void 0:t.memberList)||[]].slice(0,2);if(u.value&&e.length>1){let p,m;((r=e[0])==null?void 0:r.name)===y.name?[m,p]=e:[p,m]=e,o.value&&([m,p]=[p,m]),l.name=p.name;const D=(u.value.sysPreset?[u.value.sysPreset]:[]).concat([`角色扮演
我是${m.name||""}
${m.sysPreset||""}
你是${p.name||""}
${p.sysPreset||""}`]).join(`
`);w.sendGroupChatContent(u.value.key,p.name,o.value?{role:"user",name:m.name,content:o.value}:void 0).then(s=>{if(s.success){l.key=s.data.contentKey;const C=[{role:"system",content:D}];C.push(...s.data.list.map(L=>({role:L.name===p.name?"assistant":"user",name:L.name,content:L.content}))),o.value&&C.push({role:"user",name:m.name,content:o.value}),y.name=p.name,o.value="",Z(C)}})}},ue=()=>{w.clearGroupChatContent(u.value.key).then(()=>{z.value.getContentList()})},ie=e=>{e.shiftKey||(e.preventDefault(),Q())},d=()=>{U.params.chatKey?w.getGroupChat(+U.params.chatKey).then(e=>{e||q.push({name:"tool-ds-groupchat"}),u.value=e}):u.value=null};return ae(()=>U.params.chatKey,()=>{d()},{immediate:!0}),(e,t)=>(v(),_("div",xt,[S.value?B((v(),_("div",{key:0,class:"deepseek-mask",onClick:t[2]||(t[2]=r=>i.value=!1)},[a("div",{class:"deepseek-sider",onClick:t[1]||(t[1]=I(()=>{},["stop"]))},[a("div",wt,[x(Ve)]),a("div",Gt,[a("dl",{class:"deepseek-sider-btn",onClick:t[0]||(t[0]=r=>h.value=!0)},"设置")])])],512)),[[F,i.value]]):(v(),_("div",St,[a("div",Lt,[x(Ve)]),a("div",Mt,[a("dl",{class:"deepseek-sider-btn",onClick:t[3]||(t[3]=r=>h.value=!0)},"设置")])])),a("div",Tt,[S.value?(v(),oe(Ae,{key:0,color:"#fff",onClick:t[4]||(t[4]=r=>i.value=!0)})):E("",!0),V(U).params.chatKey&&u.value?(v(),oe(Vt,{key:1,ref_key:"detailRef",ref:z,chat:u.value,streamContent:l.content,streamReason:l.reasoning,"stream-key":l.key,onReCreate:G,onModifyContent:Y,onChatUpdate:X,onRefreshGroupchat:d},null,8,["chat","streamContent","streamReason","stream-key"])):E("",!0),V(U).params.chatKey?(v(),_("div",{key:2,style:he({zIndex:k.value.userContent?99999999:0}),onClick:t[7]||(t[7]=I(()=>{},["stop"]))},[x(se,{resize:"vertical",rows:3,placeholder:V(U).params.chatKey?"在这里发送消息":"在这里提问新建对话",modelValue:o.value,"onUpdate:modelValue":t[5]||(t[5]=r=>o.value=r),onEnter:ie},null,8,["placeholder","modelValue"]),a("div",Pt,[x(ze,{modelValue:c.value,"onUpdate:modelValue":t[6]||(t[6]=r=>c.value=r),options:V(ke)[$.aiType||"deepseek"].map(r=>({label:r,value:r}))},null,8,["modelValue","options"]),a("button",{disabled:!o.value,class:"ds-send-btn",onClick:I(Q,["stop"])},"发送",8,Dt),a("button",{class:"ds-send-btn",onClick:I(le,["stop"])},"自动聊天"),a("button",{class:"ds-send-btn",onClick:I(ue,["stop"])},"清空")])],4)):E("",!0)]),x(Be,{config:$,modelValue:h.value,"onUpdate:modelValue":t[8]||(t[8]=r=>h.value=r)},null,8,["config","modelValue"]),B(a("div",{class:"deepseek-mask",onClick:t[9]||(t[9]=()=>{k.value={userContent:null,assContent:null},o.value=""})},null,512),[[F,k.value.userContent]])]))}}),Qt=ye(Kt,[["__scopeId","data-v-b8c55d9d"]]);export{Qt as default};
