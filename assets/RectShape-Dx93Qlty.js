var L=Object.defineProperty;var m=(a,e,t)=>e in a?L(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t;var n=(a,e,t)=>m(a,typeof e!="symbol"?e+"":e,t);class _{constructor({ele:e,dpr:t=window.devicePixelRatio,width:s,height:i,allowDrop:h=!1}={}){n(this,"canvasEle");n(this,"ctx");n(this,"offScreenCtx");n(this,"shapeList",[]);n(this,"width",0);n(this,"height",0);n(this,"dpr");n(this,"offscreenCanvas");n(this,"hoverShape",null);n(this,"allowDrop");n(this,"zIndex",1);n(this,"dropInfo",null);this.dpr=t,this.allowDrop=h;let r=null;if(e?typeof e=="string"?r=document.querySelector(e):e instanceof HTMLCanvasElement&&(r=e):(r=document.createElement("canvas"),document.body.appendChild(r)),!r)throw new Error("canvas不存在");this.canvasEle=r,this.offscreenCanvas=new OffscreenCanvas(this.width,this.height),this.setCanvasSize({width:s,height:i});const c=this.offscreenCanvas.getContext("2d");if(!c)throw new Error("获取离线canvas上下文失败");this.offScreenCtx=c;const d=this.canvasEle.getContext("2d");if(!d)throw new Error("获取canvas上下文失败");this.ctx=d,this.canvasEle.addEventListener("contextmenu",l=>this.onContextMenu(l)),this.canvasEle.addEventListener("mousedown",l=>this.onMouseDown(l)),this.canvasEle.addEventListener("mousemove",l=>this.onMouseMove(l)),this.canvasEle.addEventListener("click",l=>this.onClick(l));let p=!0;window.addEventListener("mousemove",l=>{p&&(p=!1,setTimeout(()=>{p=!0},30),this.onShapeDropMove(l))}),window.addEventListener("mouseup",l=>{this.onShapeDropEnd(l)})}onShapeDropMove(e){if(this.dropInfo){const{shape:t,x:s,y:i,startX:h,startY:r}=this.dropInfo;t.update({x:h+e.clientX-s,y:r+e.clientY-i}),this.render()}}onShapeDropEnd(e){if(this.dropInfo){const{shape:t,x:s,y:i,startX:h,startY:r}=this.dropInfo;t.update({x:h+e.clientX-s,y:r+e.clientY-i}),this.render(),t.emitEvent("dropend",this.dropInfo),this.dropInfo=null}}onMouseDown(e){const t=e.offsetX*this.dpr,s=e.offsetY*this.dpr;for(let i=this.shapeList.length-1;i>=0;i--){const h=this.shapeList[i];if(h.isInShape(t,s)){e.button===0&&this.allowDrop&&h.allowDrop&&(this.dropInfo={shape:h,x:e.clientX,y:e.clientY,startX:h.x,startY:h.y},h.emitEvent("dropstart",this.dropInfo),this.render()),h.emitEvent("mousedown",{shape:h,...e});break}}}onMouseMove(e){const t=e.offsetX*this.dpr,s=e.offsetY*this.dpr,i=this.hoverShape;let h=null;for(let r=this.shapeList.length-1;r>=0;r--){const c=this.shapeList[r];if(c.hasEventListener("mousemove")&&c.isInShape(t,s)){h=c;break}}this.hoverShape=h,i!==this.hoverShape&&(i&&i.emitEvent("mouseout"),this.hoverShape&&this.hoverShape.emitEvent("mouseenter"))}onClick(e){const t=e.offsetX*this.dpr,s=e.offsetY*this.dpr;for(let i=this.shapeList.length-1;i>=0;i--){const h=this.shapeList[i];if(h.hasEventListener("click")&&h.isInShape(t,s)){h.emitEvent("click");break}}}onContextMenu(e){e.preventDefault(),e.stopPropagation();const t=e.offsetX*this.dpr,s=e.offsetY*this.dpr;for(let i=this.shapeList.length-1;i>=0;i--){const h=this.shapeList[i];if(h.hasEventListener("contextmenu")&&h.isInShape(t,s)){h.emitEvent("contextmenu");break}}}clear(){this.ctx.clearRect(0,0,this.width,this.height),this.offScreenCtx.clearRect(0,0,this.width,this.height)}setCanvasSize({width:e,height:t}={}){e&&(this.canvasEle.style.width=`${e}px`),t&&(this.canvasEle.style.height=`${t}px`),this.width=this.canvasEle.offsetWidth*this.dpr,this.height=this.canvasEle.offsetHeight*this.dpr,this.canvasEle.width=this.width,this.canvasEle.height=this.height,this.offscreenCanvas.width=this.width,this.offscreenCanvas.height=this.height}addShape(e){this.shapeList.push(e),e.zIndex=this.zIndex++,e.rootRender=this,e.parentShape=null}removeShape(e){const t=this.shapeList.indexOf(e);t>-1&&this.shapeList.splice(t,1)}render(){this.clear(),this.shapeList.sort((e,t)=>e.zIndex-t.zIndex),this.shapeList.forEach(e=>{e.render(this.offScreenCtx)}),this.ctx.drawImage(this.offscreenCanvas,0,0,this.width,this.height)}}const o=["00","01","02","03","04","05","06","07","08","09","0a","0b","0c","0d","0e","0f","10","11","12","13","14","15","16","17","18","19","1a","1b","1c","1d","1e","1f","20","21","22","23","24","25","26","27","28","29","2a","2b","2c","2d","2e","2f","30","31","32","33","34","35","36","37","38","39","3a","3b","3c","3d","3e","3f","40","41","42","43","44","45","46","47","48","49","4a","4b","4c","4d","4e","4f","50","51","52","53","54","55","56","57","58","59","5a","5b","5c","5d","5e","5f","60","61","62","63","64","65","66","67","68","69","6a","6b","6c","6d","6e","6f","70","71","72","73","74","75","76","77","78","79","7a","7b","7c","7d","7e","7f","80","81","82","83","84","85","86","87","88","89","8a","8b","8c","8d","8e","8f","90","91","92","93","94","95","96","97","98","99","9a","9b","9c","9d","9e","9f","a0","a1","a2","a3","a4","a5","a6","a7","a8","a9","aa","ab","ac","ad","ae","af","b0","b1","b2","b3","b4","b5","b6","b7","b8","b9","ba","bb","bc","bd","be","bf","c0","c1","c2","c3","c4","c5","c6","c7","c8","c9","ca","cb","cc","cd","ce","cf","d0","d1","d2","d3","d4","d5","d6","d7","d8","d9","da","db","dc","dd","de","df","e0","e1","e2","e3","e4","e5","e6","e7","e8","e9","ea","eb","ec","ed","ee","ef","f0","f1","f2","f3","f4","f5","f6","f7","f8","f9","fa","fb","fc","fd","fe","ff"];function y(){const a=Math.random()*4294967295|0,e=Math.random()*4294967295|0,t=Math.random()*4294967295|0,s=Math.random()*4294967295|0;return(o[a&255]+o[a>>8&255]+o[a>>16&255]+o[a>>24&255]+"-"+o[e&255]+o[e>>8&255]+"-"+o[e>>16&15|64]+o[e>>24&255]+"-"+o[t&63|128]+o[t>>8&255]+"-"+o[t>>16&255]+o[t>>24&255]+o[s&255]+o[s>>8&255]+o[s>>16&255]+o[s>>24&255]).toLowerCase()}class S{constructor(){n(this,"eventHandleList",{})}addEventListener(e,t){this.eventHandleList[e]||(this.eventHandleList[e]=[]),this.eventHandleList[e].push(t)}emitEvent(e,t){(this.eventHandleList[e]||[]).forEach(s=>s({type:e,target:this,data:t}))}removeEventListener(e,t){if(t){const s=this.eventHandleList[e].indexOf(t);s>-1&&this.eventHandleList[e].splice(s,1)}else delete this.eventHandleList[e]}removeAllEventListener(){this.eventHandleList={}}hasEventListener(e){return!!this.eventHandleList[e]}}class C extends S{constructor({width:t=0,height:s=0,dpr:i=window.devicePixelRatio,allowDrop:h=!1,x:r=0,y:c=0}={}){super();n(this,"visible",!0);n(this,"zIndex",0);n(this,"uuid",y());n(this,"x");n(this,"y");n(this,"width");n(this,"height");n(this,"dpr");n(this,"allowDrop");n(this,"__canvas");n(this,"__ctx");n(this,"rootRender",null);n(this,"parentShape",null);this.dpr=i,this.allowDrop=h,this.x=r,this.y=c,this.width=t,this.height=s,this.__canvas=new OffscreenCanvas(t*i,s*i);const d=this.__canvas.getContext("2d");if(d)this.__ctx=d;else throw new Error("获取离线canvas上下文失败")}get type(){return"Shape"}__updateSize({width:t,height:s,dpr:i}={}){i&&(this.dpr=i),t&&(this.__canvas.width=t*this.dpr),s&&(this.__canvas.height=s*this.dpr)}render(t){this.visible}update(t){console.log(t)}isInShape(t,s){return console.log(t,s),!1}}const x=(a,e,t,s)=>Math.sqrt((t-a)*(t-a)+(s-e)*(s-e)),M=({x:a,y:e,w:t,h:s},i)=>!!(w(i,{x:a,y:e})||w(i,{x:a+t,y:e})||w(i,{x:a,y:e+s})||w(i,{x:a+t,y:e+s})),w=({x:a,y:e,w:t,h:s},{x:i,y:h})=>i>=a&&i<=a+t&&h>=e&&h<=e+s;class D extends C{constructor({radius:t,fillColor:s="#000",strokeColor:i="#000",lineWidth:h=0,...r}){super({...r});n(this,"radius");n(this,"fillColor");n(this,"strokeColor");n(this,"lineWidth");this.radius=this.parseRaduisList(t),this.fillColor=s,this.strokeColor=i,this.lineWidth=h}get type(){return"RectShape"}parseRaduisList(t){return typeof t=="number"?[t,t,t,t]:Array.isArray(t)?(t=t.filter(s=>typeof s=="number"),t.length>=4?t.slice(0,4):t.length===1?[t[0],t[0],t[0],t[0]]:t.length===2?[t[0],t[1],t[0],t[1]]:t.length===3?[t[0],t[1],t[2],t[1]]:[0,0,0,0]):[0,0,0,0]}render(t){super.render(t);const{__ctx:s,__canvas:i,x:h,y:r,radius:c,dpr:d,width:p,height:l}=this,g=h*d,E=r*d,u=p*d,v=l*d,f=c.map(b=>b*d);s.fillStyle=this.fillColor,s.strokeStyle=this.strokeColor,s.lineWidth=this.lineWidth,s.beginPath(),s.moveTo(f[0],0),s.lineTo(u-f[1],0),f[1]>0&&s.arc(u-f[1],f[1],f[1],-Math.PI/2,0),s.lineTo(u,v-f[2]),f[2]>0&&s.arc(u-f[2],v-f[2],f[2],0,Math.PI/2),s.lineTo(f[3],v),f[3]>0&&s.arc(f[3],v-f[3],f[3],Math.PI/2,Math.PI),s.lineTo(0,f[3]),f[0]>0&&s.arc(f[0],f[0],f[0],Math.PI,Math.PI/2*3),s.fill(),s.stroke(),t.drawImage(i,g,E,u,v)}update({x:t,y:s,width:i,height:h,radius:r,fillColor:c,strokeColor:d}){typeof t<"u"&&(this.x=t),typeof s<"u"&&(this.y=s),typeof i<"u"&&(this.width=i),typeof h<"u"&&(this.height=h),typeof r<"u"&&(this.radius=this.parseRaduisList(r)),c&&(this.fillColor=c),d&&(this.strokeColor=d)}isInShape(t,s){const i=t/this.dpr,h=s/this.dpr;return!(i<this.x||i>this.x+this.width||h<this.y||h>this.y+this.height||this.radius[0]>0&&i<this.x+this.radius[0]&&h<this.y+this.radius[0]&&x(i,h,this.x+this.radius[0],this.y+this.radius[0])>this.radius[0]||this.radius[1]>0&&i>this.x+this.width-this.radius[1]&&h<this.y+this.radius[1]&&x(i,h,this.x+this.width-this.radius[1],this.y+this.radius[1])>this.radius[1]||this.radius[2]>0&&i>this.x+this.width-this.radius[2]&&h>this.y+this.height-this.radius[2]&&x(i,h,this.x+this.width-this.radius[2],this.y+this.height-this.radius[2])>this.radius[2]||this.radius[3]>0&&i<this.x+this.radius[3]&&h>this.y+this.height-this.radius[3]&&x(i,h,this.x+this.radius[3],this.y+this.height-this.radius[3])>this.radius[3])}}export{D as R,_ as S,C as a,M as b,x as g};
